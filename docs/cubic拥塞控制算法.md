# 丢包检测与拥塞控制

## QUIC 协议草案中定义的NewReno拥塞控制

在QUIC协议的丢包检测与拥塞控制协议草案中定义，QUIC协议使用的拥塞算法是基于TCP NewReno[RFC6582]实现的，这是一种基于拥塞窗口实现的拥塞控制算法。
该草案中也允许QUIC协议使用诸如Cubic[RFC8312]的拥塞控制算法。本项目中即使用的是Cubic算法。

QUIC协议的连接首先进入“慢启动”状态，当前连接发现丢包或ECN-CE计数器增长时退出“慢启动”状态。ECN-CE计数器可以认为是出现拥塞的信号。当该连接
的拥塞窗口小于“慢启动”门限时，该连接将重新进入“慢启动”状态。“慢启动”状态中的连接，在收到ACK包后执行增加拥塞窗口的动作。

QUIC协议从“慢启动”状态退出后，将进入“拥塞避免”阶段。在NewReno算法中，本阶段采用加法增加乘法减少（AIMD）的方式来调整拥塞窗口大小。当通信的
一方接收到ACK响应后，拥塞窗口增加一个*最大包长度*。当通信的一方发现丢包后，NewReno算法将拥塞窗口减半，并且将“慢启动”的门限设置为减半后的拥塞
窗口大小。

QUIC协议的“恢复阶段”是在发现丢包后的一段时间，或者ECN-CE计数器增加的时候的连接状态。在“恢复阶段”的QUIC连接，拥塞窗口将保持不变。

## CUBIC拥塞控制算法

在本项目中，拥塞控制使用的是CUBIC算法。CUBIC算法是对BIC算法的一种改进算法，因此要了解CUBIC算法，首先需要对BIC算法进行一个大概的了解。BIC算法的
本质是通过二分查找策略，来探寻当前网络环境下的最合适的拥塞窗口大小。

BIC算法基于以下事实：

1. 连接发生丢包后，当前网络环境下最合适的拥塞窗口大小应该小于当前拥塞窗口;
2. 连接发生丢包，并且已经将拥塞窗口乘性降低，则当前网络环境下最合适的拥塞窗口大小应该大于当前拥塞窗口。

BIC算法工作于“恢复阶段”之后，在上述两个事实中可以获知寻找合适的拥塞窗口的区间。BIC算法在这一区间内进行二分搜索，每接收到一个ACK消息时，即触发一次
搜索，直到逼近该搜索区间中的上限值。在搜索过程中逼近上限值，就意味着最合适的拥塞窗口应该存在于大于上限值的区间内，BIC算法采用基于上限值对称的策略，
将搜索路径对称放置在大于上限值区间内的特定几个点上。

BIC算法在探寻最合适的拥塞窗口过程中，每次探寻都是由接收到一个ACK消息触发，也就是说每次探寻的时间间隔大致是一个RTT的间隔时间。但这样会导致处在相同
时间段的不同连接，由于RTT的不同，会导致占用带宽上的不公平，即具备越短的RTT连接越能占有更多的网络带宽资源。CUBIC算法首先在触发探寻的事件采用绝对时
间间隔，这样就避免了BIC算法中RTT时间越短越容易占据网络带宽资源的不公平。并且CUBIC算法的探寻路径采用数学公式进行推导，避免了现实中的各种约束。

BIC的探寻过程是一个拥塞窗口增长率慢慢变小又慢慢变大的过程，对应一条三次曲线，并且这条三次曲线应该是一个有界的对称曲线。曲线的起始位置应该是“慢启动”
的门限位置，曲线的中间位置为探寻区间的上限。通过推演可得到从“恢复阶段”结束后的时刻算起，某一时刻t的拥塞窗口应为f(t)，公式如下:

```
m(t) = t - cbrt(((1 - beta) * max_cwnd) / c)
f(t) = c * m(t) * m(t) * m(t) + max_cwnd
```
其中c决定了触发探索拥塞窗口的时间间隔，当c越大时，触发探索拥塞窗口的时间间隔越短。beta决定了这条三次曲线的对称范围的增长率。

在执行CUBIC算法过程中，同样发现分为三个周期：

1. 稳定阶段
2. 探测阶段
3. 减窗阶段
